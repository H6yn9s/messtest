<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini E-ZBio Clone</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.32.0/dist/supabase.min.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #4a90e2, #9013fe);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }

    .window {
        background: #1e1e1e;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        width: 400px;
        padding: 30px;
        color: #fff;
        transition: all 0.3s;
    }

    h2 { text-align: center; margin-bottom: 20px; }

    input, textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        border: none;
        outline: none;
        font-size: 14px;
    }

    textarea { resize: none; height: 80px; }

    button {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 12px;
        border: none;
        background: #4a90e2;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
    }

    button:hover { background: #357ab8; }

    .profile { text-align: center; }

    .avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #4a90e2;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #fff;
        overflow: hidden;
    }

    .avatar img { width: 100%; height: 100%; object-fit: cover; }

    .logout-btn { background: #e24a4a; }
    .logout-btn:hover { background: #b83434; }

    .hidden { display: none; }
</style>
</head>
<body>

<div class="window" id="registerWindow">
    <h2>Регистрация / Вход</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Пароль">
    <input type="text" id="username" placeholder="Имя пользователя">
    <button onclick="registerUser()">Зарегистрироваться</button>
    <button onclick="loginUser()">Войти</button>
</div>

<div class="window hidden" id="profileWindow">
    <div class="profile">
        <div class="avatar" id="avatar">U</div>
        <input type="file" id="avatarInput" accept="image/*">
        <h3 id="profileName"></h3>
        <textarea id="bio" placeholder="Ваша биография..."></textarea>
        <button onclick="updateProfile()">Сохранить профиль</button>
        <button class="logout-btn" onclick="logoutUser()">Выйти</button>
    </div>
</div>

<script>
    // --- Supabase Setup ---
    const SUPABASE_URL = 'https://dhvwvxlhoobcrzmbwqxn.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_wkQ3Om3iwgSROBUTvpqhww_Vt4p-uPk';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    async function registerUser() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const username = document.getElementById('username').value;

        if (!email || !password || !username) {
            alert('Заполните все поля');
            return;
        }

        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) { alert(error.message); return; }

        currentUser = data.user;

        // Создаём профиль в таблице profiles
        await supabase.from('profiles').insert([{ id: currentUser.id, username, bio: '', avatar_url: '' }]);
        showProfile();
    }

    async function loginUser() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { alert(error.message); return; }

        currentUser = data.user;
        showProfile();
    }

    async function showProfile() {
        document.getElementById('registerWindow').classList.add('hidden');
        document.getElementById('profileWindow').classList.remove('hidden');

        const { data: profile } = await supabase.from('profiles').select().eq('id', currentUser.id).single();

        document.getElementById('profileName').textContent = profile.username;
        document.getElementById('bio').value = profile.bio || '';
        document.getElementById('avatar').innerHTML = profile.avatar_url 
            ? `<img src="${profile.avatar_url}">`
            : profile.username.charAt(0).toUpperCase();
    }

    async function updateProfile() {
        const bio = document.getElementById('bio').value;
        const fileInput = document.getElementById('avatarInput');

        let avatar_url = null;

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}.${fileExt}`;

            const { data, error } = await supabase.storage.from('avatars').upload(fileName, file, { upsert: true });
            if (error) { alert(error.message); return; }

            const { publicUrl } = supabase.storage.from('avatars').getPublicUrl(fileName);
            avatar_url = publicUrl;
        }

        await supabase.from('profiles').update({ bio, avatar_url }).eq('id', currentUser.id);
        showProfile();
        alert('Профиль обновлён!');
    }

    async function logoutUser() {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('profileWindow').classList.add('hidden');
        document.getElementById('registerWindow').classList.remove('hidden');
    }
</script>

</body>
</html>
